<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chylers Chatbot Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #333;
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #999;
            font-size: 12px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .section h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table thead {
            background: #f8f9fa;
        }

        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            border-bottom: 2px solid #e9ecef;
        }

        table td {
            padding: 15px;
            color: #666;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .inquiry-bar {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .inquiry-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .inquiry-bar-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .inquiry-bar-value {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }

        .inquiry-bar-fill {
            height: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            table th, table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Chylers Chatbot Analytics</h1>
            <p>Real-time insights into customer conversations and lead capture</p>
        </div>

        <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading analytics data...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Conversations</h3>
                    <div class="value" id="totalConversations">-</div>
                    <div class="label">All time</div>
                </div>
                <div class="stat-card">
                    <h3>Total Messages</h3>
                    <div class="value" id="totalMessages">-</div>
                    <div class="label">Exchanged</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Messages</h3>
                    <div class="value" id="avgMessages">-</div>
                    <div class="label">Per conversation</div>
                </div>
                <div class="stat-card">
                    <h3>Active Sessions</h3>
                    <div class="value" id="activeSessions">-</div>
                    <div class="label">Right now</div>
                </div>
            </div>

            <!-- Product Inquiries -->
            <div class="section">
                <h2>üîç Product Inquiry Breakdown</h2>
                <div id="productInquiries"></div>
            </div>

            <!-- Leads Table -->
            <div class="section">
                <h2>üìß Captured Leads</h2>
                <div id="leadsTable"></div>
            </div>

            <!-- Recent Conversations -->
            <div class="section">
                <h2>üí¨ Recent Conversations</h2>
                <div id="conversationsTable"></div>
            </div>

            <!-- Daily Activity -->
            <div class="section">
                <h2>üìÖ Daily Activity</h2>
                <div id="dailyActivity"></div>
            </div>
        </div>
    </div>

    <script>
        async function loadData() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');

            loading.style.display = 'block';
            content.style.display = 'none';

            try {
                // Load analytics
                const analyticsRes = await fetch('/api/analytics');
                const analytics = await analyticsRes.json();

                // Update stats
                document.getElementById('totalConversations').textContent = analytics.summary.totalConversations;
                document.getElementById('totalMessages').textContent = analytics.summary.totalMessages;
                document.getElementById('avgMessages').textContent = analytics.summary.averageMessagesPerConversation;
                document.getElementById('activeSessions').textContent = analytics.summary.activeConversations;

                // Product Inquiries
                renderProductInquiries(analytics.productInquiries);

                // Daily Activity
                renderDailyActivity(analytics.conversationsByDay);

                // Load Supabase data
                await loadSupabaseData();

                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (error) {
                console.error('Error loading data:', error);
                loading.innerHTML = '<p style="color: #dc3545;">Error loading data. Please check console.</p>';
            }
        }

        async function loadSupabaseData() {
            const supabaseUrl = window.location.origin;

            try {
                // Try to fetch leads and conversations from Supabase
                // Note: You'll need to create API endpoints for this
                const leadsRes = await fetch(`${supabaseUrl}/api/leads`);
                const conversationsRes = await fetch(`${supabaseUrl}/api/conversations`);

                if (leadsRes.ok) {
                    const leads = await leadsRes.json();
                    renderLeadsTable(leads);
                } else {
                    renderEmptyLeads();
                }

                if (conversationsRes.ok) {
                    const conversations = await conversationsRes.json();
                    renderConversationsTable(conversations);
                } else {
                    renderEmptyConversations();
                }
            } catch (error) {
                console.error('Supabase data error:', error);
                renderEmptyLeads();
                renderEmptyConversations();
            }
        }

        function renderProductInquiries(inquiries) {
            const total = Object.values(inquiries).reduce((sum, val) => sum + val, 0);

            if (total === 0) {
                document.getElementById('productInquiries').innerHTML = `
                    <div class="empty-state">
                        <p>No product inquiries yet</p>
                    </div>
                `;
                return;
            }

            const html = Object.entries(inquiries).map(([key, value]) => {
                const percentage = total > 0 ? (value / total * 100) : 0;
                const label = key.charAt(0).toUpperCase() + key.slice(1);

                return `
                    <div class="inquiry-bar">
                        <div class="inquiry-bar-header">
                            <span class="inquiry-bar-label">${label}</span>
                            <span class="inquiry-bar-value">${value} (${percentage.toFixed(1)}%)</span>
                        </div>
                        <div class="inquiry-bar-fill" style="width: ${percentage}%"></div>
                    </div>
                `;
            }).join('');

            document.getElementById('productInquiries').innerHTML = html;
        }

        function renderLeadsTable(leads) {
            if (!leads || leads.length === 0) {
                renderEmptyLeads();
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Source</th>
                            <th>Captured At</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${leads.map(lead => `
                            <tr>
                                <td><strong>${lead.email}</strong></td>
                                <td>${lead.name || '-'}</td>
                                <td>${lead.phone || '-'}</td>
                                <td><span class="badge badge-success">${lead.source}</span></td>
                                <td>${new Date(lead.timestamp).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('leadsTable').innerHTML = html;
        }

        function renderEmptyLeads() {
            document.getElementById('leadsTable').innerHTML = `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <p>No leads captured yet</p>
                </div>
            `;
        }

        function renderConversationsTable(conversations) {
            if (!conversations || conversations.length === 0) {
                renderEmptyConversations();
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Session</th>
                            <th>Messages</th>
                            <th>Last Message</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${conversations.slice(0, 10).map(conv => `
                            <tr>
                                <td><code>${conv.session_id.substring(0, 12)}...</code></td>
                                <td><span class="badge badge-info">${conv.message_count} msgs</span></td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${conv.user_message}
                                </td>
                                <td>${new Date(conv.timestamp).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('conversationsTable').innerHTML = html;
        }

        function renderEmptyConversations() {
            document.getElementById('conversationsTable').innerHTML = `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <p>No conversations yet</p>
                </div>
            `;
        }

        function renderDailyActivity(conversationsByDay) {
            if (!conversationsByDay || Object.keys(conversationsByDay).length === 0) {
                document.getElementById('dailyActivity').innerHTML = `
                    <div class="empty-state">
                        <p>No activity data yet</p>
                    </div>
                `;
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Conversations</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(conversationsByDay).reverse().map(([date, count]) => `
                            <tr>
                                <td><strong>${date}</strong></td>
                                <td><span class="badge badge-warning">${count} conversations</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('dailyActivity').innerHTML = html;
        }

        // Load data on page load
        loadData();

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>
